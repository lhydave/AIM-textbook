% font set
\usepackage{fontspec}
\usepackage[sc]{mathpazo}
\usepackage{anyfontsize}

\setmainfont{SourceSerif4-Regular.ttf}[%
    Path = ./fonts/,
    BoldFont = SourceSerif4-Bold.ttf,
    ItalicFont = SourceSerif4-It.ttf,
    BoldItalicFont = SourceSerif4-BoldIt.ttf
]
\setCJKmainfont[%
    Path = ./fonts/,
    BoldFont=SourceHanSansSC-Medium.otf,
    ItalicFont=gkai00mp-2.ttf%
]{SourceHanSansSC-Normal.otf}

% colors
\usepackage[dvipsnames]{xcolor}
\definecolor{pku-red}{RGB}{139,0,18}
\usepackage{colortbl}
\newcommand{\light}[1]{\textcolor{Orchid}{#1}}
\newcommand{\contrastlight}[1]{\textcolor{TealBlue}{#1}}

% environments
\usepackage{array}
\usepackage{caption}
\usepackage[shortlabels,inline]{enumitem}
\usepackage{booktabs}
\usepackage{makecell}
\usepackage{float}
\usepackage{multicol}
\usepackage{etoolbox}
\usepackage{graphicx}
\usepackage{multirow}
\usepackage{inputenx}
\usepackage{subcaption}

% author and title
\usepackage[blocks]{authblk}    % author and affiliation
\usepackage{titling}            % title

\pretitle{\begin{center}\Huge\bfseries}
\posttitle{\end{center}\vspace{8em}}
\renewcommand\Authfont{\itshape\Large}
\renewcommand\Authand{\quad}


\usepackage[normalem]{ulem}

% math package
\let\Bbbk\relax
\usepackage{amsmath}
\usepackage{mathrsfs}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{stmaryrd}
\usepackage{latexsym}
\usepackage{extarrows}
\SetSymbolFont{stmry}{bold}{U}{stmry}{m}{n}
\allowdisplaybreaks[3]

% math theorems
\usepackage{mdframed}
\usepackage[thmmarks,amsmath]{ntheorem}
\newtheorem{construction}{构造}[chapter]
\newtheorem{observation}{观察}[chapter]
\newtheorem{lemma}{引理}[chapter]
\newtheorem{proposition}{命题}[chapter]
\newtheorem{corollary}{推论}[chapter]
\newtheorem{theorem}{定理}[chapter]
\newtheorem{principle}{规则}[chapter]
\newtheorem{hypothesis}{假设}[chapter]
\newtheorem{axiom}{公理}[chapter]
{
\theoremstyle{plain}
\theoremheaderfont{\bfseries}
\theorembodyfont{\normalfont}
\theoremsymbol{\ensuremath{\Box}}
\newtheorem{definition}{定义}[chapter]
}
{
\theoremstyle{plain}
\theoremheaderfont{\bfseries}
\theorembodyfont{\normalfont}
\theoremsymbol{\ensuremath{\Box}}
\newtheorem{example}{例}[chapter]
}
{
\theoremstyle{nonumberplain}
\theorembodyfont{\normalfont}
\newmdtheoremenv{remark}{注. }
\AtBeginEnvironment{remark}{\small}
}
{
\theoremstyle{nonumberplain}
\theoremheaderfont{\bfseries}
\theorembodyfont{\normalfont}
\theoremsymbol{\ensuremath{\Box}}
\newtheorem{proof}{证明. }
}

% chap/section set
\ctexset{
    chapter={format={\raggedright\bfseries\Huge}},
    section={format={\raggedright\bfseries\LARGE},name={\S,}},
    subsection={format={\raggedright\bfseries\large},name={\S,}}
}

% page style set
\usepackage[a5paper,top=2.5cm,bottom=2.5cm,left=2cm,right=2cm]{geometry}
\usepackage{nonumonpart}
\usepackage{setspace}
\setstretch{1.5}
\AtBeginEnvironment{tabular}{\renewcommand{\arraystretch}{1.5}}

% footer and header
\usepackage{fancyhdr}
\fancypagestyle{plain}{
    \fancyhf{}  % Clear header and footer
    \renewcommand{\headrulewidth}{0pt}  % Remove the line under the header
    \renewcommand{\footrulewidth}{0pt}  % Remove the line above the footer
}
\pagestyle{fancy}
% Clear default header and footer fields
\fancyhf{}
% Prevent uppercase in headers
\fancyhead[RE]{\nouppercase{\itshape\leftmark}}
\fancyhead[LO]{\nouppercase{\itshape\rightmark}}
\fancyhead[RO,LE]{\thepage}
\fancyfoot{}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\usepackage{emptypage}  % 确保空白页不显示页眉页脚

% cleveref
\usepackage{crossreftools}
% \pdfstringdefDisableCommands{%
%     \let\Cref\crtCref
%     \let\cref\crtcref
% }
\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=pku-red,     
    urlcolor=violet,
    citecolor=BlueViolet,
    pdffitwindow=true,
}
\usepackage[capitalize]{cleveref}

% customize Chinese cref name
\Crefformat{construction}{构造\,#2#1#3}
\Crefformat{part}{第#2#1#3部分}
\Crefformat{chapter}{第#2#1#3章}
\Crefformat{section}{第\,#2#1#3\,节}
\Crefformat{theorem}{定理\,#2#1#3}
\Crefformat{lemma}{引理\,#2#1#3}
\Crefformat{proposition}{命题\,#2#1#3}
\Crefformat{corollary}{推论\,#2#1#3}
\Crefformat{observation}{观察\,#2#1#3}
\Crefformat{hypothesis}{假设\,#2#1#3}
\Crefformat{definition}{定义\,#2#1#3}
\Crefformat{remark}{注\,#2#1#3}
\Crefformat{example}{例\,#2#1#3}
\Crefformat{figure}{图\,#2#1#3}
\Crefformat{table}{表\,#2#1#3}
\Crefformat{appendix}{附录\,#2#1#3}

% remarks
\newcommand\lhysays[1]{\textcolor{blue}{[lhy: #1]}}

% exercise set
\newenvironment{hint}{% hint
\par\itshape 提示：
}{}

\renewcommand{\theenumii}{\arabic{enumii}}

% plots
\usepackage{tikz-cd}

% math notations
\newcommand{\LHS}{\mathrm{LHS}}
\newcommand{\RHS}{\mathrm{RHS}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\E}{\mathbb{E}}
\renewcommand{\O}{\mathcal{O}}
\newcommand{\id}{\mathrm{id}}
\DeclareMathOperator*{\Span}{Span}
\DeclareMathOperator*{\im}{Im}
\DeclareMathOperator*{\rank}{rank}
\DeclareMathOperator*{\card}{card}
\DeclareMathOperator*{\grad}{grad}
\DeclareMathOperator*{\argmax}{argmax}
\DeclareMathOperator*{\epi}{epi}
\DeclareMathOperator*{\maximize}{maximize}
\DeclareMathOperator*{\minimize}{minimize}
\renewcommand{\d}{\mathrm{d}}
\newcommand{\Pow}{\mathcal{P}}
\newcommand{\cov}{\mathsf{Cov}}
\newcommand{\var}{\mathsf{Var}}
\newcommand{\Nor}{\mathcal{N}}
\newcommand{\U}{\mathcal{U}}
\renewcommand{\t}{\mathsf{T}}
\newcommand{\T}{\top}
\newcommand{\F}{\bot}
\newcommand{\norm}[1]{\left\|#1\right\|}
\newcommand{\inner}[2]{\left\langle{#1},{#2}\right\rangle}
\newcommand{\e}{\mathrm{e}}
\newcommand{\const}{\mathrm{const}}
\newcommand{\scB}{\mathscr{B}}
\newcommand{\scF}{\mathscr{F}}
\newcommand{\G}{\mathscr{G}}
\newcommand{\Exp}{\mathsf{Exp}}
\newcommand{\DExp}{\mathsf{DExp}}
\newcommand{\Lap}{\mathsf{Lap}}
\newcommand{\calP}{\mathcal P}
\newcommand{\calS}{\mathcal S}
\newcommand{\calF}{\mathcal F}
\newcommand{\calM}{\mathcal M}
\newcommand{\KL}{\mathrm{KL}}
\newcommand{\ReLU}{\mathsf{ReLU}}
\newcommand{\val}{\mathsf{val}}

% compiling time
\usepackage{datetime}
\ctexset{today=small}
\newcommand{\lastcompiled}{\vspace*{\fill}
\begin{center}
最后一次编译的时间：\today\ \currenttime~(UTC+8)
\end{center}
}